---
- name: check if go {{ go_version }} is installed
  shell: which go && go version | grep {{ go_version }}
  register: go_is_installed
  failed_when: false
  changed_when: false

- name: cleanup previously installed go
  file:
    path: "{{ go_install_base_dir }}/go"
    state: absent
  become: true
  when: go_is_installed.rc != 0

- name: install go {{ go_version }}
  unarchive:
    src: https://dl.google.com/go/go{{ go_version }}.linux-amd64.tar.gz
    dest: "{{ go_install_base_dir }}"
    remote_src: True
  become: true
  when: go_is_installed.rc != 0

- name: add go to PATH
  lineinfile:
    path: ~/.bashrc
    state: present
    line: export PATH=$PATH:/usr/local/go/bin

- name: create go workspace
  file:
    path: "{{ go_path }}"
    state: directory
    mode: 0755

- name: add workspace environment variable
  lineinfile:
    path: ~/.bashrc
    state: present
    line: export GOPATH={{ go_path }}

- name: add go binaries to PATH
  lineinfile:
    path: ~/.bashrc
    state: present
    line: export PATH=$PATH:{{ go_path }}/bin

- name: add package cache to PATH
  lineinfile:
    path: ~/.bashrc
    state: present
    line: export GOMODCACHE={{ go_path }}/pkg/mod

- name: setup bash completion
  get_url:
    url: https://raw.githubusercontent.com/skelterjohn/go-pkg-complete/master/go-pkg-complete.bash.inc
    dest: /etc/bash_completion.d/go
    mode: 0644
  become: true

- name: install shfmt (shell formatter)
  shell: go install mvdan.cc/sh/v3/cmd/shfmt@latest
  args:
    creates: "{{ go_path }}/bin/shfmt"
  environment:
    PATH: "{{ go_install_base_dir }}/go/bin:{{ ansible_env.PATH }}"
    GOPATH: "{{ go_path }}"

- name: install golangci-lint
  shell: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
  args:
    creates: "{{ go_path }}/bin/golangci-lint"
  environment:
    PATH: "{{ go_install_base_dir }}/go/bin:{{ ansible_env.PATH }}"
    GOPATH: "{{ go_path }}"
...
